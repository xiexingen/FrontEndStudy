---
title: 前端上传
order: 15
nav:
  title: 随笔
  path: /articles
group:
  title: 通用
---

汇总文件上传的一些常用方式

# 切片上传

## 客户端

1. 使用 Blob.prototype.slice 方法对文件进行切片
2. 使用 [spark-md5](https://github.com/satazor/js-spark-md5) 库计算文件 hash 值，并使用 web worker 开启新的线程执行。（该库不能直接计算整个文件，需要分片进行计算，具体可以看它官网的例子 [spark-md5-example](https://github.com/satazor/js-spark-md5/blob/master/test/readme_example.html)。
3. 将各个分片文件上传到服务器，并携带 hash
4. 当所有文件上传完后，需要发送合并请求，携带文件 hash、后缀名、分片大小

## 服务端

- 根据接收到的 hash 创建文件夹，将分片文件存储到文件夹中
- 收到合并请求后，读取各个分片文件。根据 hash 和后缀名，合并生成完整文件
- 清理存储分片文件的文件夹及其内容

- 服务器端增加定时任务对异常操作的文件进行清理(如:上传了一部分客户端网络原因或误操作离开页面)

# 断点续传

在上传文件之前，计算 hash，将 hash 传给服务器
服务器根据 hash 和后缀，查看是否已经上传
如果没有完整文件，就查找有无分片数据
如果有，则返回已上传的分片列表
如果没有，客户端需要执行上传动作

## 客户端

## 服务端

# 秒传

其实就是看服务器端是否已经存在该文件

## 客户端

- 上传文件之前，计算 hash，然后将 hash 和文件名发送到服务器
- 服务器返回文件是否存在的状态
- 如果存在，客户端提示文件上传成功，否则执行上传动作

## 服务端

- 服务器根据 hash 和后缀名，在服务器中查找该文件
- 返回该文件存在的状态
